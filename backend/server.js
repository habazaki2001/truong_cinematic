require("dotenv").config();
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const multer = require("multer");
const path = require("path");
const app = express();
app.use(cors());
app.use(express.json());

const isAdmin = (req, res, next) => {
  try {
    const token = req.headers.authorization?.split(" ")[1];
    if (!token) return res.status(403).json({ message: "Kh√¥ng c√≥ token" });

    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    if (decoded.role !== "admin") {
      return res.status(403).json({ message: "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" });
    }

    req.user = decoded; // G√°n user v√†o request ƒë·ªÉ s·ª≠ d·ª•ng sau n√†y
    next();
  } catch (error) {
    return res.status(403).json({ message: "Token kh√¥ng h·ª£p l·ªá" });
  }
};

const MONGO_URI = process.env.MONGO_URI;

console.log("üîç MONGO_URI:", MONGO_URI);
if (!MONGO_URI) {
  console.error("‚ùå L·ªñI: Bi·∫øn m√¥i tr∆∞·ªùng MONGO_URI ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a!");
  process.exit(1);
}
// K·∫øt n·ªëi MongoDB
mongoose
  .connect(MONGO_URI)
  .then(() => console.log("‚úÖ Connected to MongoDB"))
  .catch((err) => console.error("‚ùå MongoDB connection error:", err));

// ƒê·ªãnh nghƒ©a Schema v√† Model
// const phimSchema = new mongoose.Schema(
//   {
//     id: Number,
//     tenPhim: String,
//     soTap: Number,
//     quocGia: [String],
//     theLoai: [String],
//     phimBo: Boolean,
//     phimLe: Boolean,
//     anh: String,
//     tapPhim: [
//         {
//             tap: Number,
//             link: String,
//             luotXem: Number,
//         }
//     ],
//     like: Number,
//     comment: [
//       {
//         id: Number,
//         avt: String,
//         tenTk: String,
//         cmt: String
//       }
//     ],
//     nam: Number,
//     moTa: String
//   },
//   { collection: "list_phims" } // ƒê·∫£m b·∫£o d√πng ƒë√∫ng collection trong MongoDB
// );


const phimSchema = new mongoose.Schema(
  {
    movie_url: String,
    comment: [
      {
        id: Number,
        avt: String,
        tenTk: String,
        cmt: String
      }
    ],
    createdAt: Date,
    daodien : String,
    dienvien: String,
    episodes: [
      {
        episode: Number,
        iframe_url: String,
        m3u8_url: String,
        server: Number 
      }
    ],
    id: Number,
    image: String,
    like: [],
    namsanxuat: String,
    ngonngu: String,
    quocgia: [],
    slug: String,
    theloai: [],
    thoiluong: String,
    tinhtrang: String,
    title: String,
    total_episodes: Number,
    trangthai: String,
    updatedAt: Date,
    view: Number
  },
  { collection: "khophim" } // ƒê·∫£m b·∫£o d√πng ƒë√∫ng collection trong MongoDB
);


const Phim = mongoose.model("Phim", phimSchema);

// API l·∫•y danh s√°ch phim
app.get("/phim", async (req, res) => {
  try {
    const data = await Phim.find();
    res.json(data);
  } catch (error) {
    console.error("L·ªói khi l·∫•y danh s√°ch phim:", error);
    res.status(500).json({ message: "L·ªói server" });
  }
});

// API l·∫•y phim theo ID 
app.get("/phim/:id", async (req, res) => {
  try {
    const phim = await Phim.findOne({ id: Number(req.params.id) }); // Convert id th√†nh s·ªë
    if (!phim) {
      return res.status(404).json({ message: "Phim kh√¥ng t·ªìn t·∫°i" });
    }
    res.json(phim);
  } catch (error) {
    console.error(`L·ªói khi l·∫•y phim c√≥ ID ${req.params.id}:`, error);
    res.status(500).json({ message: "L·ªói server" });
  }
});

// API th√™m phim m·ªõi
app.post("/addphim", isAdmin, async (req, res) => {
  try {
    const {movie_url, comment, createdAt, daodien, dienvien, episodes, id, image, like, namsanxuat, ngonngu, quocgia, slug, theloai, thoiluong, tinhtrang, title, total_episodes, trangthai, updatedAt, view } = req.body;
    const lastPhim = await Phim.findOne().sort({ id: -1 });
    const newId = lastPhim ? lastPhim.id + 1 : 1;
    // T·∫°o m·ªõi phim t·ª´ d·ªØ li·ªáu g·ª≠i l√™n
    const newPhim = new Phim({
      movie_url,
      comment,
      createdAt,
      daodien ,
      dienvien,
      episodes,
      id: newId,
      image,
      like,
      namsanxuat,
      ngonngu,
      quocgia,
      slug,
      theloai,
      thoiluong,
      tinhtrang,
      title,
      total_episodes,
      trangthai,
      updatedAt,
      view
    });

    // L∆∞u phim v√†o MongoDB
    await newPhim.save();

    res.status(201).json({ message: "Phim ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!", phim: newPhim });
  } catch (error) {
    console.error("L·ªói khi th√™m phim:", error);
    res.status(500).json({ message: "L·ªói server" });
  }
});

// API c·∫≠p nh·∫≠t phim theo ID
app.put("/update/:id",isAdmin, async (req, res) => {
  try {
    const phimId = Number(req.params.id);
    const updatedData = req.body;

    const phim = await Phim.findOneAndUpdate({ id: phimId }, updatedData, { new: true });

    if (!phim) {
      return res.status(404).json({ message: "Phim kh√¥ng t·ªìn t·∫°i" });
    }

    res.json({ message: "Phim ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!", phim });
  } catch (error) {
    console.error(`L·ªói khi c·∫≠p nh·∫≠t phim c√≥ ID ${req.params.id}:`, error);
    res.status(500).json({ message: "L·ªói server" });
  }
});

// API x√≥a phim theo ID
app.delete("/delete/:id",isAdmin, async (req, res) => {
  try {
    const phimId = Number(req.params.id);
    
    const deletedPhim = await Phim.findOneAndDelete({ id: phimId });

    if (!deletedPhim) {
      return res.status(404).json({ message: "Phim kh√¥ng t·ªìn t·∫°i" });
    }

    res.json({ message: "Phim ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!" });
  } catch (error) {
    console.error(`L·ªói khi x√≥a phim c√≥ ID ${req.params.id}:`, error);
    res.status(500).json({ message: "L·ªói server" });
  }
});

// API Like phim
app.patch("/phim/:id/updateLikes", async (req, res) => {
  const filmId = req.params.id;
  const newLikeArray = req.body.like;
  try {
    const result = await Phim.findOneAndUpdate(
      { id: filmId },
      { like: newLikeArray },
      { new: true }
    );

    if (!result) {
      return res.status(404).json({ success: false, message: "Phim kh√¥ng t√¨m th·∫•y" });
    }

    res.json({ success: true, film: result });
  } catch (error) {
    console.error("Error updating likes:", error);
    res.status(500).json({ success: false, message: "L·ªói server" });
  }
});

// API th√™m b√¨nh lu·∫≠n v√†o phim
app.post("/phim/:id/comment", async (req, res) => {
  const { id } = req.params;
  const { tenTk, avt, cmt } = req.body;

  if (!tenTk || !cmt) {
    return res.status(400).json({ message: "Thi·∫øu th√¥ng tin b√¨nh lu·∫≠n." });
  }

  try {
    const phim = await Phim.findOne({ id: Number(id) });
    if (!phim) {
      return res.status(404).json({ message: "Phim kh√¥ng t·ªìn t·∫°i." });
    }

    const newComment = {
      id: phim.comment.length + 1,
      avt: avt || "", // Avatar c√≥ th·ªÉ r·ªóng
      tenTk,
      cmt,
    };

    phim.comment.push(newComment);
    phim.markModified('comment'); // th√™m d√≤ng n√†y!
    await phim.save();

    res.status(200).json({ message: "B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c th√™m!", newComment });
  } catch (error) {
    console.error("L·ªói khi th√™m b√¨nh lu·∫≠n:", error);
    res.status(500).json({ message: "L·ªói server." });
  }
});

// API tƒÉng view phim
app.post("/phim/:slug/updateView", async (req, res) => {
  try {
    const phim = await Phim.findOneAndUpdate(
      { slug: req.params.slug },
      { $inc: { view: 1 } }, // tƒÉng view l√™n 1
      { new: true }
    );
    res.json({ success: true, view: phim.view });
  } catch (err) {
    res.status(500).json({ success: false, message: "L·ªói server" });
  }
});



// USER
const userSchema = new mongoose.Schema({
  username: { type: String, required: true, unique: true },
  email: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  avatar: { type: String },
  role: { type: String, enum: ["user", "admin"], default: "user" } 
}, { collection: "users" });


const User = mongoose.model("User", userSchema);

// üîπ C·∫•u h√¨nh l∆∞u ·∫£nh avatar v√†o th∆∞ m·ª•c uploads/
const storage = multer.diskStorage({
  destination: "uploads/",
  filename: (req, file, cb) => {
    cb(null, Date.now() + path.extname(file.originalname)); // T·∫°o t√™n file theo th·ªùi gian
  },
});
const upload = multer({ storage });

// ==================== ƒêƒÇNG K√ù =====================
app.post("/auth/register", upload.single("avatar"), async (req, res) => {
  try {
    const { username, email, password } = req.body;
    const avatar = req.file ? `/uploads/${req.file.filename}` : "/uploads/default.jpg"; // N·∫øu kh√¥ng c√≥ ·∫£nh, d√πng m·∫∑c ƒë·ªãnh

    const existingUserEmail = await User.findOne({ email });
    if (existingUserEmail) return res.status(400).json({ message: "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng" });

    const existingUsernam = await User.findOne({ username });
    if (existingUsernam) return res.status(400).json({ message: "username ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng" });

    const hashedPassword = await bcrypt.hash(password, 10);
    const newUser = new User({ username, email, password: hashedPassword, avatar });
    await newUser.save();

    res.status(201).json({ message: "ƒêƒÉng k√Ω th√†nh c√¥ng!", avatar });
  } catch (error) {
    console.error("L·ªói ƒëƒÉng k√Ω:", error);
    res.status(500).json({ message: "L·ªói server" });
  }
});

app.use("/uploads", express.static("uploads"));

// ==================== ƒêƒÇNG NH·∫¨P =====================
app.post("/auth/login", async (req, res) => {
  try {
    const { username, password } = req.body;

    const user = await User.findOne({ username });
    if (!user) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }

    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      return res.status(400).json({ message: "M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c" });
    }

    const token = jwt.sign({ userId: user._id, role: user.role }, process.env.JWT_SECRET, { expiresIn: "7d" });

    res.json({ 
      token, 
      user: { id: user._id, username: user.username, role: user.role, avatar: user.avatar } 
    });
  } catch (error) {
    console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
    res.status(500).json({ message: "L·ªói server" });
  }
});



app.use("/uploads", express.static(path.join(__dirname, "uploads")));


// Kh·ªüi ƒë·ªông server
const PORT = process.env.PORT || 4400;
app.listen(PORT, () => {
  console.log(`üöÄ Server is running on port ${PORT}`);
});


